<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet" id="bootstrap-css">
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<!------ Include the above in your HEAD tag ---------->

<form class="form-horizontal" action='' method="POST">
  <fieldset>
    <div id="legend">
      <legend class="">회원가입</legend>
    </div>
    <div class="control-group">
      <!-- Username -->
      <label class="control-label"  for="username">닉네임</label>
      <div class="controls">
        <input type="text" id="username" class="username" name="username" placeholder="" class="input-xlarge" onkeyup="this.value=this.value.replace(/[^a-zA-Z-_0-9]/g,'');">
      </div>
    </div>
 
    <div class="control-group">
      <!-- Password-->
      <label class="control-label" for="password">비밀번호</label>
      <div class="controls">
        <input type="password" id="password" class="password" name="password" placeholder="" class="input-xlarge">
      </div>
    </div>
 
    <div class="control-group">
      <!-- Password -->
      <label class="control-label"  for="password_confirm">비밀번호 확인</label>
      <div class="controls">
        <input type="password" id="password_confirm" class="password_confirm" name="password_confirm" placeholder="" class="input-xlarge">
      </div>
    </div>
 
    <div class="control-group">
      <!-- Button -->
      <div class="controls">
        <button class="btn btn-success" type="button" onclick="register();">가입하기</button>
      </div>
    </div>
  </fieldset>
</form>


<!-- 회권가입 스크립트 -->
<script type="text/javascript">
	
/* 	
 	- 회원가입 버튼을 클릭하기
	- 닉네임, 비밀번호, 비밀번호 확인을 입력하기
	- 닉네임은 `최소 3자 이상, 알파벳 대소문자(a~z, A~Z), 숫자(0~9)`로 구성하기
	- 비밀번호는 `최소 4자 이상이며, 닉네임과 같은 값이 포함된 경우 회원가입에 실패`로 만들기
	- 비밀번호 확인은 비밀번호와 정확하게 일치하기
	- 데이터베이스에 존재하는 닉네임을 입력한 채 회원가입 버튼을 누른 경우 "중복된 닉네임입니다." 라는 에러메세지를 프론트엔드에서 보여주기
	- 회원가입 버튼을 누르고 에러메세지가 발생하지 않는다면 `로그인 페이지`로 이동시키기
 */
 
	//가입하기
	function register(){
		let username = $('.username').val();
	    let password = $('.password').val();
	    let password_confirm = $('.password_confirm').val();
	    let data = {'username': username, 'password': password, 'password_confirm': password_confirm};
	    
		 if (checkName() != "") { //닉네임 체크
            alert(checkName());
            return false;
        }
        
        if (checkPass() != "") { //비밀번호 체크
            alert(checkPass());
            return false;
        }
        
        checkNameDuplication(function(response){ //닉네임 중복 체크
    		if(response.username){
    			alert("닉네임 중복 입니다.");
    			return false;
    		}else{
    			//회원가입 
    			 $.ajax({
			        type:'POST',
			        url:'/api/register',
			        contentType:'application/json',
			        data: JSON.stringify(data),
			        async : false,
			        beforeSend : function(xhr, opts) {
			            
			        },
			        success: function (response){
			            alert("회원 가입이 완료 되었습니다!");
			            location.href = "/loginForm";
			        }
			    });
    		}
    	});
	}
	
	// 닉네임 체크
	function checkName(){
		let err_msg = "";
		let username = $('.username').val();
		let regExp = /^(?=.*\d)(?=.*[a-zA-Z])[0-9a-zA-Z]{3,10}$/; //  3 ~ 10자 영문, 숫자 조합
		
		if (username == '') {
	    	err_msg = '닉네임을 적어주세요!';
	    } else if(!regExp.test(username)){ 
			err_msg = "닉네임은 숫자와 영문자 조합으로 3~10자리를 사용해야 합니다.";
	    }
		return err_msg;
	}
	
	// 닉네임 중복 체크
	function checkNameDuplication(callback){
		let username = $('.username').val();
		 $.ajax({
	        type:'GET',
	        url:`/api/user/${username}`,
	        contentType:'application/json',
	        beforeSend : function(xhr, opts) {
	        },
	        success: function (response){
	        	callback(response); //동기화 처리
	        }
	    });
	}
	
	//비밀번호 체크
	function checkPass(){
		let err_msg = "";
		let username = $('.username').val();
		let password = $('.password').val();
		let password_confirm = $('.password_confirm').val();
		
		if (password == '' || password_confirm == '') {
	    	err_msg = '패스워드를 적어주세요!';
	    } else if(password.length < 4 || password.length > 10){ 
			err_msg = '비밀번호는  4~10자리를 사용해야 합니다.'; 
	    } else if(password.indexOf(username) != -1){
			err_msg = "비밀번호에 닉네임을 포함할 수 없습니다.";
		} else if (password != password_confirm) {
	    	err_msg = '패스워드가 일치하지 않습니다!';
	    } 
		
		return err_msg;
	}
	
	
</script>